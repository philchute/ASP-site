@page
@model ASP_site.Pages.Books.Rand.IndexModel
@using ASP_site.Models
@using ASP_site.Helpers

@{
    ViewData["Title"] = "Ayn Rand";
    ViewData["ActivePage"] = "Rand";
}

<form class="mb-4">
    <div class="row align-items-end">
        <div class="col-md-5">
            <h2 class="display-3">Ayn Rand</h2>
        </div>
        <div class="col-md-7">
            <div class="d-flex justify-content-end align-items-end">
                <div class="form-group me-2">
                    <label class="form-label" for="search-input">Search:</label>
                    <div class="d-flex">
                        <input id="search-input" class="form-control" type="text" asp-for="SearchString" />
                        <button class="btn btn-secondary ms-1" type="submit">Search</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="sort-select">Sort by:</label>
                    <select id="sort-select" class="form-control" asp-for="SortField" asp-items="Model.SortOptions" onchange="this.form.submit();"></select>
                </div>
            </div>
        </div>
    </div>
    <hr />
    <div class="row mt-3">
        <div class="col-md-2">
            <label class="form-label fw-bold">Type:</label>
            @foreach (var type in Model.AllBookTypes)
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="SelectedBookTypes" value="@type.Key" id="type_@type.Key.GetHashCode()" checked="@(Model.SelectedBookTypes.Contains(type.Key))" onchange="this.form.submit();" />
                    <label class="form-check-label" for="type_@type.Key.GetHashCode()">@type.Value</label>
                </div>
            }
        </div>
        <div class="col-md-2">
            <label class="form-label fw-bold">Tags:</label>
            @foreach (var tag in Model.AllTags)
            {
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="SelectedTags" value="@tag.Key" id="tag_@tag.Key.GetHashCode()" checked="@(Model.SelectedTags.Contains(tag.Key))" onchange="this.form.submit();" />
                    <label class="form-check-label" for="tag_@tag.Key.GetHashCode()">@tag.Value</label>
                </div>
            }
        </div>
        <div class="col-md-8">
            <label class="form-label fw-bold">Collections:</label>
            <div class="row">
                @foreach (var chunk in Model.AllCollections.Select((value, i) => new { i, value }).GroupBy(x => x.i / (int)Math.Ceiling((double)Model.AllCollections.Count / 3)))
                {
                    <div class="col-4">
                        @foreach (var item in chunk)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="SelectedCollections" value="@item.value.Key" id="coll_@item.value.Key.GetHashCode()" checked="@(Model.SelectedCollections.Contains(item.value.Key))" onchange="this.form.submit();" />
                                <label class="form-check-label" for="coll_@item.value.Key.GetHashCode()">@item.value.Value</label>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</form>

<p>
    Ayn Rand was born in Russia in 1905 and moved to the United States in 1926. 
    Her 1943 novel 'The Fountainhead' and 1957 novel 'Atlas Shrugged' are her two most famous works, 
    and are two of the best English language novels ever written. This page lists all her works including 
    the lesser known novels and plays.     
    Pre-2005 editions of <a href="https://en.wikipedia.org/wiki/The_Early_Ayn_Rand" target="_blank">The Early Ayn Rand</a> 
    did not include 'The Night King' or 'The Simplest Thing in the World'.
</p>

<section class="grid mt-3">
    <div class="row g-0 bg-dark text-white fw-bold">
        <div class="p-1 text-center col-1 col-sm-2">Year</div>
        <div class="p-1 text-center col-1 col-sm-1">Type</div>
        <div class="p-1 text-start col-5 col-sm-4">Title <i>(@(Model.Books?.Count ?? 0) shown)</i></div>
        <div class="p-1 text-start col-2 col-sm-2">Tags</div>
        <div class="p-1 text-start col-3 col-sm-3">Collections</div>
    </div>

    @if(Model.Books != null && Model.Books.Any()) {
        foreach (var book in Model.Books) { 
            var collections = book.Tags.Where(t => t.Name.StartsWith("Collection: ")).ToList();
            var generalTags = book.Tags.Where(t => !t.Name.StartsWith("Collection: ")).ToList();

            <a asp-page="../Book" asp-route-BookTitle="@book.Title" class="row g-0 text-decoration-none text-reset border-bottom table-row-hover">
                <div class="p-1 text-center col-12 col-sm-2">
                    @if (book.PublicationMonth.HasValue)
                    {
                        <span>@ViewHelper.GetMonthName(book.PublicationMonth), </span>
                    }
                    @book.PublicationYear
                </div>
                <div class="p-1 text-center col-12 col-sm-1">@book.Type</div>
                <div class="p-1 text-start col-12 col-sm-4 text-white">@book.Title</div>
                <div class="p-1 text-start col-12 col-sm-2">
                    @foreach (var tag in generalTags)
                    {
                        <span class="badge bg-secondary me-1">@tag.Name</span>
                    }
                </div>
                <div class="p-1 text-start col-12 col-sm-3 d-flex flex-wrap align-content-start">
                    @foreach (var collection in collections)
                    {
                        <span class="badge bg-secondary me-1 mb-1">@collection.Name.Replace("Collection: ", "")</span>
                    }
                </div>
            </a>
        }
    } else {
        <p class="p-2">No books found matching your criteria.</p>
    }
</section> 

<style>
    .table-row-hover:hover {
        background-color: #303030;
    }
</style>
